!function(ctx){function duplicateObject(e,n){if("object"==typeof e&&null!==e){if(n=void 0!==n?n:20,n>0)if(e.hasOwnProperty("length"))for(var i=[],t=0;t<e.length;t++)i[t]="object"!=typeof e[t]?e[t]:duplicateObject(e[t],n-1);else{var i={};for(var t in e)i[t]="object"!=typeof e[t]?e[t]:duplicateObject(e[t],n-1)}return i}return e}bindings={bindings:{},createModal:function(e,n){var i=new this.Modal(e,n);return e._binding=i,e},applyBindings:function(e,n){e=e||{},e instanceof this.Modal?e.applyBindings(n):e._binding instanceof this.Modal&&e._binding.applyBindings(n)},_parseBindings:function(e,n){if(!(e instanceof Node))throw new Error("first argument has to be a Node");if(!(n instanceof bindings.Scope||n instanceof bindings.Value))throw new Error("second argument has to be a Scope or a Value");for(var i=[],t=e.attributes||[],s=0;s<t.length;s++){var r=t.item(s),o=r.name;if(-1!==o.search("bind-")){o=o.substr(o.indexOf("-")+1,o.length);var a=r.value,h=new bindings.Binding(e,a,n,o);i.push(h)}}return i},_eval:function(string,scope){if(!(scope instanceof bindings.Scope||scope instanceof bindings.Value))throw new Error("second argument has to be a Scope or a Value");string=string||"";var data={value:void 0,success:!0},func="new Function(",args=[],context=scope.value;func+='"return ',func+=string,func+='")',func=eval(func);try{data.value=func.apply(context,args)}catch(e){data.success=!1}return data},_evalRequires:function(string,scope){if(!(scope instanceof bindings.Scope||scope instanceof bindings.Value))throw new Error("second argument has to be a Scope or a Value");string=string||"";var data={success:!0,requires:[],sets:[],gets:[]},scopeVars={console:{},window:{},navigator:{},localStorage:{},location:{},alert:bindings.noop,eval:bindings.noop},buildContextFromScope=function(e){var n=new e.values.__proto__.constructor;for(var i in e.values)n.__defineGetter__(i,function(e,n,i){return i.requires.push(this.values[n]),i.gets.push(this.values[n]),"function"!=typeof this.values[n].value?this.values[n].value:void 0}.bind(e,n,i,data)),n.__defineSetter__(i,function(e,n,i){i.requires.push(this.values[n]),i.sets.push(this.values[n])}.bind(e,n,i,data));return n},func="new Function(",args=[],context={};for(var i in scopeVars)func+='"'+i+'",',args.push(scopeVars[i]);scope instanceof bindings.Scope?(context=buildContextFromScope(scope),data.gets=[],data.sets=[],data.requires=[]):scope instanceof bindings.Value&&(context=scope.value),func+='"return ',func+=string,func+='")',func=eval(func);try{func.apply(context,args)}catch(e){data.success=!1}for(var d=[],i=0;i<data.requires.length;i++)-1==d.indexOf(data.requires[i])&&d.push(data.requires[i]);return data.requires=d,data},noop:function(){}},bindings.Modal=function(e,n){this.options=Object.create(this.options),this.scope=new bindings.Scope("",e),n=n||{};for(var i in n)this.options[i]=n[i];return this},bindings.Modal.prototype={bindings:[],options:{element:document},scope:void 0,applyBindings:function(e){if(!(e instanceof Node)&&e)throw new Error("first argument has to be a Node");e&&(this.options.element=e),this.removeAllBindings(),this.bindings=this.scope.applyBindings(this.options.element)},getBinding:function(e){if(!(e instanceof Node))throw new Error("first argument has to be a Node");for(var n=0;n<this.bindings.length;n++)if(this.bindings[n].el===e)return this.bindings[n]},removeBinding:function(e){if(!(e instanceof Node))throw new Error("first argument has to be a Node");var n=this.getBinding(e);if(n){n._unbind();for(var i=0;i<this.bindings.length;i++)if(this.bindings[i].el===e)return void delete this.bindings[i]}},removeAllBindings:function(){for(var e=0;e<this.bindings.length;e++)this.bindings[e]._unbind();this.bindings=[]}},bindings.Modal.prototype.constructor=bindings.Modal,bindings.Scope=function(e,n,i){return n=n||{},this.key=e||"",this.value=n,this.values=n.hasOwnProperty("length")?[]:{},this.events={},this.parent=i,this.updateKeys(n),Object.observe(this.value,function(e){for(var n=0;n<e.length;n++)if("_binding"!=e[n].name)switch(e[n].type){case"add":this.addKey(e[n].name,e[n].object[e[n].name]);break;case"update":this.updateKey(e[n].name,e[n].object[e[n].name]);break;case"delete":this.removeKey(e[n].name)}}.bind(this)),this},bindings.Scope.prototype={events:{},object:void 0,parent:void 0,values:void 0,addKey:function(e,n){this.values[e]="object"==typeof n?new bindings.Scope(e,n,this):new bindings.Value(e,n,this),this.emit("change",this)},removeKey:function(e){delete this.values[e],this.emit("change",this)},updateKey:function(e,n){this.values[e]||this.addKey(e,n),this.values[e]instanceof bindings.Value?this.values[e].setValue(n):this.values[e]instanceof bindings.Scope&&this.values[e].updateKeys(n),this.emit("change",this)},updateKeys:function(e){e=e||{};for(var n in e)this.updateKey(n,e[n])},getKey:function(e){for(var n in this.values)if(this.values[n].value==e)return n},getValue:function(e){return this.values[e]},getValueFromValue:function(e){return this.getValue(this.getKey(e))},update:function(){this.emit("change",this)},on:function(e,n,i){this.events[e]||(this.events[e]=[]),i&&(n=n.bind(i)),this.events[e].push(n)},off:function(e,n){this.events[e]||(this.events[e]=[]),-1!==this.events[e].indexOf(n)&&this.events[e].splice(this.events[e].indexOf(n),1)},emit:function(e,n,i){this.events[e]||(this.events[e]=[]);for(var t=0;t<this.events[e].length;t++)this.events[e][t](n);switch(i){case"up":this.parent&&this.parent.emit(e,void 0,i);break;case"down":for(var t in this.values)this.values[t].emit(e,void 0,i)}},applyBindings:function(e){if(!(e instanceof Node))throw new Error("first argument has to be a Node");var n=[];if(e.__bindings__)for(var i=e.__bindings__.length-1;i>=0;i--)e.__bindings__[i]._unbind();for(var i=0;i<e.children.length;i++){var t=bindings._parseBindings(e.children[i],this);n=n.concat(t),e.children[i].children&&(e.children[i].__scope__=e.children[i].__scope__||this,n=n.concat(e.__bindings__=e.children[i].__scope__.applyBindings(e.children[i])))}return n}},bindings.Scope.prototype.constructor=bindings.Scope,bindings.Value=function(e,n,i){return this.key=e,this.value=n,this.events={},this.parent=i,this},bindings.Value.prototype={value:void 0,parent:void 0,events:{},on:function(e,n,i){this.events[e]||(this.events[e]=[]),i&&(n=n.bind(i)),this.events[e].push(n)},off:function(e,n){this.events[e]||(this.events[e]=[]),-1!==this.events[e].indexOf(n)&&this.events[e].splice(this.events[e].indexOf(n),1)},emit:function(e,n,i){this.events[e]||(this.events[e]=[]);for(var t=0;t<this.events[e].length;t++)this.events[e][t](n);switch(i){case"up":this.parent&&this.parent.emit(e,void 0,i);break;case"down":}},setValue:function(e){this.value=e||this.value,this.emit("change",e)},update:function(){this.emit("change",this.value)}},bindings.Value.prototype.constructor=bindings.Value,bindings.Binding=function(e,n,i,t){if(!(i instanceof bindings.Scope||i instanceof bindings.Value))throw new Error("third argument has to be a Scope or a Value");this.el=e,this.scope=i,this.src=new bindings.Src(n,this.scope),this.type=t;var s=bindings.bindings[t];if(s)for(var r in s)this[r]=s[r];else console.error("cant find binding type: "+t);return this._bind(),this._update(),this},bindings.Binding.prototype={el:void 0,scope:void 0,src:void 0,events:[],_bind:function(){this._updateEvents(),this.bind()},_update:function(){try{this.update()}catch(e){console.error("failed to bind: { "+this.src.string+" } on element"),console.error(this.el),console.error(e)}},_unbind:function(){this._unbindEvents(),this.unbind()},_unbindEvents:function(){for(var e=0;e<this.events.length;e++)this.events[e].obj.off(this.events[e].type,this.events[e].func);this.events=[]},_bindEvents:function(){for(var e=this.src.getRequires(),n=0;n<e.length;n++)this.events.push({type:"change",func:this._update.bind(this),obj:e[n]}),e[n].on("change",this._update.bind(this))},_updateEvents:function(){this._unbindEvents(),this._bindEvents()},bind:function(){},unbind:function(){},update:function(){},getScope:function(){}},bindings.Binding.prototype.constructor=bindings.Binding,bindings.Src=function(e,n){if(!(n instanceof bindings.Scope||n instanceof bindings.Value))throw new Error("second argument has to be a Scope or a Value");return this.string=e||"",this.scope=n,this},bindings.Src.prototype={value:void 0,success:!0,sting:"",scope:void 0,requires:void 0,update:function(){var e=bindings._eval(this.string,this.scope);return this.value=e.value,this.success=e.success,this},getRequires:function(e){return(!this.requires||e)&&(this.requires=bindings._evalRequires(this.string,this.scope).requires),this.requires}},bindings.Src.prototype.constructor=bindings.Src,document.children||document.__defineGetter__("children",function(){return this.body.children}),function(e){e.bindings.text={update:function(){this.src.update(),this.el.textContent=this.src.value}},e.bindings.click={bind:function(){this.event=this.event||function(){this.src.update()}.bind(this)},update:function(){this.el.removeEventListener("click",this.event),this.el.addEventListener("click",this.event)}},e.bindings["with"]={update:function(){this.src.update();var n=this.scope.getValueFromValue(this.src.value);if(!(n instanceof e.Scope))throw new Error("with requires a Object or Array");for(var i=0;i<this.el.children.length;i++)this.el.children[i].__scope__=n}},e.bindings.foreach={__foreach_children__:[],removeAllChildren:function(){for(;0!==this.el.children.length;)this.el.removeChild(this.el.children[0])},bind:function(){for(var e=[],n=0;n<this.el.children.length;n++)e.push(this.el.children[n]);this.__foreach_children__=e},update:function(){this.removeAllChildren(),this.src.update();var n=this.scope.getValueFromValue(this.src.value);if(!(n instanceof e.Scope))throw new Error("foreach requires a Object or Array");for(var i in n.values)for(var t=0;t<this.__foreach_children__.length;t++){var s=this.__foreach_children__[t].cloneNode(!0);s.__scope__=n.values[i],this.el.appendChild(s)}this.scope.applyBindings(this.el)},unbind:function(){this.removeAllChildren();for(var e=0;e<this.__foreach_children__.length;e++){var n=this.__foreach_children__[e].cloneNode(!0);this.el.appendChild(n)}}},e.bindings.repeat={__foreach_children__:[],removeAllChildren:function(){for(;0!==this.el.children.length;)this.el.removeChild(this.el.children[0])},bind:function(){for(var e=[],n=0;n<this.el.children.length;n++)e.push(this.el.children[n]);this.__foreach_children__=e},update:function(){this.removeAllChildren(),this.src.update();for(var e=0;e<this.src.value;e++)for(var n=0;n<this.__foreach_children__.length;n++){var i=this.__foreach_children__[n].cloneNode(!0);this.el.appendChild(i)}this.scope.applyBindings(this.el)},unbind:function(){this.removeAllChildren();for(var e=0;e<this.__foreach_children__.length;e++){var n=this.__foreach_children__[e].cloneNode(!0);this.el.appendChild(n)}}}}(bindings),ctx.bindings=bindings}(this);